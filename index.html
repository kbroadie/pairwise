<!doctype html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Survey</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Platypi:ital,wght@0,300..800;1,300..800&family=Radio+Canada:ital,wght@0,300..700;1,300..700&display=swap');
body { background-color: #23272a; color: #919395; font-family: 'Radio Canada', sans-serif; display: flex; flex-direction: column; justify-content: space-between; height: 100vh; margin: 0; }
main { flex: 1; display: flex; flex-direction: column; justify-content: center; position: relative; }
.term-pair { display: flex; justify-content: center; align-items: center; height: 60vh; position: relative; margin-top: -10vh; }
.term-button { width: 40%; height: 80%; margin: 0 15px; padding: 40px; font-size: 3.5em; background-color: #1c2124; color: #919395; border: none; border-radius: 20px; cursor: pointer; position: relative; font-family: 'Platypi', sans-serif; font-weight: 300; }
.term-button.selected { background-color: #00660f; color: #ffffff; }
.term-button:focus { outline: none; }
#results { text-align: left; margin-top: 20px; }
.circle-container { display: flex; justify-content: center; align-items: center; position: relative; height: 10vh; width: 100%; }
.circle { display: flex; justify-content: center; align-items: center; font-size: 2.5em; width: 3em; height: 3em; margin: 0 0.1em; border-radius: 5px; cursor: pointer; font-family: 'Radio Canada', sans-serif; font-style: Regular; font-weight: 500; transition: background-color 0.3s, opacity 0.3s, color 0.3s, transform 0.3s; }
.circle:not(.ghost):hover {
  transform: scale(1.05);
  background-color: #00660f !important;
  color: #ffffff !important;
}
.circle.ghost { opacity: 0.5; pointer-events: none; }
.term-pair:not(:has(.term-button.selected)) ~ .circle-container .circle:hover {
  transform: none;
  background-color: inherit !important;
  color: inherit !important;
}
#next-button, #previous-button, #restart-button { font-size: 1em; display: block; padding: 18px 20px; background-color: transparent; color: #919395; border: 0.5px solid #919395; border-radius: 5px; cursor: pointer; transition: background-color 0.3s, color 0.3s; }
#next-button:hover, #previous-button:hover, #restart-button:hover { background-color: #00660f; color: #ffffff; }
#previous-button { position: absolute; bottom: 40px; left: 20px; }
#next-button { position: absolute; bottom: 40px; right: 20px; }
#restart-button { margin: 20px auto; }
#progress-bar { width: 100%; background-color: #333333; height: 10px; position: absolute; bottom: 0; }
#count { text-align: right; color: #666666; margin-bottom: 10px; margin-right: 10px; opacity: 0.5; position: absolute; bottom: 0px; right: 0; }
#progress { width: 0; height: 100%; background-color: #00660f; }
#controls-container { position: absolute; top: 10px; right: 10px; display: flex; align-items: center; }
#auto-advance-button, #edit-terms-button { padding: 10px; background-color: #1c2124; color: #919395; border: none; border-radius: 5px; cursor: pointer; margin-left: 10px; transition: background-color 0.3s, color 0.3s; }
#auto-advance-button.active, #edit-terms-button:hover { background-color: #00660f; color: #ffffff; }
#edit-terms-modal { display: none; position: fixed; z-index: 1; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4); }
.modal-content { background-color: #23272a; margin: 15% auto; padding: 20px; border: 1px solid #888; width: 80%; max-width: 600px; border-radius: 10px; font-family: 'Radio Canada', sans-serif; }
#terms-list { width: 100%; height: 200px; background-color: #1c2124; color: #919395; border: none; margin-bottom: 10px; border-radius: 5px; padding: 10px; font-family: 'Radio Canada', sans-serif; }
.modal-button { padding: 10px; margin: 5px; background-color: #1c2124; color: #919395; border: none; border-radius: 5px; cursor: pointer; transition: background-color 0.3s, color 0.3s; }
.modal-button:hover { background-color: #00660f; color: #ffffff; }
#results table { width: 60%; margin: 20px auto; border-collapse: collapse; font-family: 'Radio Canada', sans-serif; }
#results th, #results td { border: 1px solid #1c2124; padding: 10px; }
#results th { text-align: left; background-color: #1c2124; }
#results tr:nth-child(even) { background-color: #1c2124; }
#results h2 { font-family: 'Platypi', sans-serif; text-align: center; margin-top: 20px; color: #ffffff; }
</style>
</head>
<body>
<main>
<div id="survey"></div>
<div id="count"></div>
<div id="controls-container">
  <button id="auto-advance-button">Auto-Advance</button>
  <button id="edit-terms-button">Edit Terms</button>
</div>
<div id="progress-bar"><div id="progress"></div></div>
<div id="results"></div>
</main>

<div id="edit-terms-modal">
  <div class="modal-content">
    <h2>Edit Terms</h2>
    <p>Add, remove, or edit terms. Each term should be on a new line.</p>
    <textarea id="terms-list"></textarea>
    <button class="modal-button" id="save-terms">Save Changes</button>
    <button class="modal-button" id="cancel-edit">Cancel</button>
  </div>
</div>

<script>
// Initialization and Setup

let terms = [
  "Reduce Congestion",
  "Reduce Accidents",
  "Improve Pavement Condition",
  "Fill System Gaps",
  "Encourage Infill Development",
  "Improve Climate & Disaster Resiliency",
  "Improve Access In & Out of the Coachella Valley",
  "Add Pedestrian & Bicycle Routes",
  "Improve Air Quality, Environment, and Aesthetics",
  "Improve Access In & Out of Events",
  "Build Infrastructure in Disadvantaged Communities",
  "Improve Mobility for Disadvantaged Commuters"
];
let responses = [],
pairs = [];
let currentPairIndex = 0,
selectedCircleIndices = [];
let autoAdvanceEnabled = false;

function createSurvey() {
  pairs = [];
  for (let e = 0; e < terms.length; e++)
    for (let t = e + 1; t < terms.length; t++) pairs.push([terms[e], terms[t]]);
  selectedCircleIndices = Array(pairs.length).fill(null);
  responses = [];
  currentPairIndex = 0;
  showNextPair();
}

// Survey Navigation

function showNextPair() {
  let e = document.getElementById("survey");
  if (((e.innerHTML = ""), currentPairIndex < pairs.length)) {
    let [t, r] = pairs[currentPairIndex],
    n = document.createElement("div");
    n.classList.add("question"),
    (n.innerHTML = `
      <div class="term-pair">
        <button class="term-button ${responses[currentPairIndex] === t ? "selected" : ""}" onclick="selectTerm('${t}', 0)" aria-label="Select ${t}">${t}</button>
        <button class="term-button ${responses[currentPairIndex] === r ? "selected" : ""}" onclick="selectTerm('${r}', 1)" aria-label="Select ${r}">${r}</button>
      </div>
      <div class="circle-container">
        ${Array.from({ length: 8 }).map((e, n) => `
          <div class="circle circle-${getCircleNumber(n)} ${selectedCircleIndices[currentPairIndex] === n ? "selected" : ""}" 
               onclick="selectCircle(${n})" 
               style="${4 === n ? "margin-left: 30px;" : ""}">${getCircleNumber(n)}</div>
        `).join("")}
      </div>
      <div class="navigation-buttons">
        <button id="previous-button" style="display: ${currentPairIndex > 0 ? "block" : "none"};" onclick="showPreviousPair()">< BACK</button>
        <button id="next-button" onclick="advanceToNextPair()">${currentPairIndex === pairs.length - 1 ? "See Results" : "NEXT >"}</button>
      </div>
    `),
    e.appendChild(n),
    updateCount(),
    updateProgressBar();
    updateTermButtonColors();
    updateCircleColors();
    updateNextButtonVisibility();
  } else showResults();
}

function showPreviousPair() {
  currentPairIndex > 0 && (currentPairIndex--, showNextPair());
}
  
function advanceToNextPair() {
  if (responses[currentPairIndex] && selectedCircleIndices[currentPairIndex] !== null) {
    currentPairIndex++;
    if (currentPairIndex >= pairs.length) {
      showResults();
    } else {
      showNextPair();
    }
  }
}

// User Interaction

function selectTerm(e, termIndex) {
  let termButtons = document.querySelectorAll(".term-button");
  let wasSelected = termButtons[termIndex].classList.contains("selected");
  let otherTermWasSelected = termButtons[1 - termIndex].classList.contains("selected");

  termButtons.forEach((button, index) => {
    if (index === termIndex) {
      button.classList.toggle("selected");
    } else {
      button.classList.remove("selected");
    }
  });

  if (wasSelected) {
    responses[currentPairIndex] = undefined;
    deselectCircle(); // Deselect circle when deselecting a term
  } else {
    responses[currentPairIndex] = e;
    if (otherTermWasSelected) {
      deselectCircle(); // Deselect circle when switching to the other term
    }
  }

  updateTermButtonColors();
  updateNextButtonVisibility();
  updateCircleColors();
}

function selectCircle(e) {
  let circles = document.querySelectorAll(".circle");
  let wasSelected = false;
  
  circles.forEach((circle, index) => {
    if (index === e) {
      if (circle.classList.contains("selected")) {
        circle.classList.remove("selected");
        wasSelected = true;
      } else {
        circle.classList.add("selected");
        selectAssociatedTerm(index);
      }
    } else {
      circle.classList.remove("selected");
    }
  });
  
  if (wasSelected) {
    selectedCircleIndices[currentPairIndex] = null;
  } else {
    selectedCircleIndices[currentPairIndex] = e;
  }
  
  updateNextButtonVisibility();
  updateCircleColors();
  
  // Auto-advance if enabled, with a 300ms delay
  if (autoAdvanceEnabled) {
    setTimeout(() => {
      advanceToNextPair();
    }, 300);
  }
}

function selectAssociatedTerm(circleIndex) {
  let termButtons = document.querySelectorAll(".term-button");
  let termIndex = circleIndex < 4 ? 0 : 1;
  let term = pairs[currentPairIndex][termIndex];
  
  termButtons.forEach((button, index) => {
    if (index === termIndex) {
      button.classList.add("selected");
    } else {
      button.classList.remove("selected");
    }
  });
  
  responses[currentPairIndex] = term;
  updateTermButtonColors();
}

function deselectCircle() {
  let circles = document.querySelectorAll(".circle");
  circles.forEach(circle => circle.classList.remove("selected"));
  selectedCircleIndices[currentPairIndex] = null;
}

// UI Updates

function updateCircleColors() {
  let circles = document.querySelectorAll(".circle");
  const selectedColor = "#00660f";
  const pageBackgroundColor = "#23272a";
  let selectedTermIndex = getSelectedTermIndex();

  circles.forEach((circle, index) => {
    let circleNumber = getCircleNumber(index);
    let baseColorHSL = {
      h: 34 - (circleNumber - 1) * 6,
      s: 90 - (circleNumber - 1) * 10,
      l: 40
    };
    
    if (index === selectedCircleIndices[currentPairIndex]) {
      circle.style.backgroundColor = selectedColor;
      circle.style.color = "#ffffff";
      circle.classList.remove("ghost");
    } else {
      let opacity = 0;
      if (selectedTermIndex === -1) {
        opacity = 0;
      } else if ((index < 4 && selectedTermIndex === 0) || (index >= 4 && selectedTermIndex === 1)) {
        opacity = 1;
      }
      
      circle.style.backgroundColor = `hsla(${baseColorHSL.h}, ${baseColorHSL.s}%, ${baseColorHSL.l}%, ${opacity})`;
      
      // Calculate text color based on the background
      let textColor;
      if (opacity === 0) {
        // Use page background color with increased luminosity when circle background is transparent
        textColor = increaseLuminosity(hexToHSL(pageBackgroundColor), 30);
      } else {
        // Use circle's own color with increased luminosity when circle background is opaque
        textColor = increaseLuminosity(baseColorHSL, 30);
      }
      circle.style.color = textColor;
      
      // Apply ghost class based on selected term
      if (selectedTermIndex === -1 || (index < 4 && selectedTermIndex === 0) || (index >= 4 && selectedTermIndex === 1)) {
        circle.classList.remove("ghost");
      } else {
        circle.classList.add("ghost");
      }
    }

    circle.style.opacity = circle.classList.contains("ghost") ? "0.5" : "1";
  });
}
  
function updateNextButtonVisibility() {
  let e = document.getElementById("next-button");
  if (responses[currentPairIndex] && selectedCircleIndices[currentPairIndex] !== null) {
    e.style.display = "block";
  } else {
    e.style.display = "none";
  }
}
  
function updateTermButtonColors() {
  let termButtons = document.querySelectorAll(".term-button");
  const nonSelectedColor = "#1c2124";
  const selectedColor = "#00660f";

  termButtons.forEach((button) => {
    if (button.classList.contains("selected")) {
      button.style.backgroundColor = selectedColor;
      button.style.color = "#ffffff";
    } else {
      button.style.backgroundColor = nonSelectedColor;
      button.style.color = increaseLuminosity(hexToHSL(nonSelectedColor), 80);
    }
  });
}
  
function updateCount() {
  let e = document.getElementById("count");
  e.innerHTML = `Pair ${currentPairIndex + 1} of ${pairs.length}`;
}

function updateProgressBar() {
  let e = document.getElementById("progress"),
  t = ((currentPairIndex + 1) / pairs.length) * 100;
  e.style.width = `${t}%`;
}

// Results Display

function showResults() {
  let mainContent = document.querySelector('main');
  let resultsContainer = document.getElementById("results");
  let termScores = calculateTermScores();
  let sortedTerms = Object.entries(termScores)
    .sort((a, b) => b[1] - a[1]);

  // Clear the main content
  mainContent.innerHTML = '';

  // Create the results table
  let tableHTML = `
    <table>
      <thead>
        <tr>
          <th>Term</th>
          <th style="text-align: right;">Total Score</th>
        </tr>
      </thead>
      <tbody>
        ${sortedTerms.map(([term, score], index) => `
          <tr>
            <td>${term}</td>
            <td style="text-align: right;">${score}</td>
          </tr>
        `).join('')}
      </tbody>
    </table>
  `;

  // Update the results container
  resultsContainer.innerHTML = `
    <h2>Results</h2>
    ${tableHTML}
    <button id="restart-button">Restart Survey</button>
  `;

  // Append the results container to the main content
  mainContent.appendChild(resultsContainer);

  // Add event listener for the restart button
  document.getElementById('restart-button').addEventListener('click', restartSurvey);

  // Remove unnecessary elements
  let elementsToRemove = ['#survey', '#count', '#controls-container', '#progress-bar'];
  elementsToRemove.forEach(selector => {
    let element = document.querySelector(selector);
    if (element) element.remove();
  });
}

function calculateTermScores() {
  let termScores = {};

  // Initialize scores for all terms
  terms.forEach(term => termScores[term] = 0);

  // Calculate scores
  responses.forEach((selectedTerm, index) => {
    if (selectedTerm !== undefined && selectedCircleIndices[index] !== null) {
      let score = getCircleNumber(selectedCircleIndices[index]);
      termScores[selectedTerm] += score;
    }
  });

  return termScores;
}

function restartSurvey() {
  // Reset survey data
  responses = [];
  selectedCircleIndices = [];
  currentPairIndex = 0;

  // Recreate the survey structure
  createSurvey();

  // Update the main content
  let mainContent = document.querySelector('main');
  mainContent.innerHTML = `
    <div id="survey"></div>
    <div id="count"></div>
    <div id="controls-container">
      <button id="auto-advance-button">Auto-Advance</button>
      <button id="edit-terms-button">Edit Terms</button>
    </div>
    <div id="progress-bar"><div id="progress"></div></div>
    <div id="results"></div>
  `;

  // Reattach event listeners
  document.getElementById('auto-advance-button').addEventListener('click', toggleAutoAdvance);
  document.getElementById('edit-terms-button').addEventListener('click', openEditTermsModal);

  // Show the first pair
  showNextPair();
}

// Utility Functions

function hexToHSL(hex) {
  let r = 0, g = 0, b = 0;
  if (hex.length == 4) {
    r = parseInt(hex[1] + hex[1], 16);
    g = parseInt(hex[2] + hex[2], 16);
    b = parseInt(hex[3] + hex[3], 16);
  } else if (hex.length == 7) {
    r = parseInt(hex.slice(1, 3), 16);
    g = parseInt(hex.slice(3, 5), 16);
    b = parseInt(hex.slice(5, 7), 16);
  }
  r /= 255;
  g /= 255;
  b /= 255;
  let cmin = Math.min(r,g,b),
      cmax = Math.max(r,g,b),
      delta = cmax - cmin,
      h = 0,
      s = 0,
      l = 0;

  if (delta == 0)
    h = 0;
  else if (cmax == r)
    h = ((g - b) / delta) % 6;
  else if (cmax == g)
    h = (b - r) / delta + 2;
  else
    h = (r - g) / delta + 4;

  h = Math.round(h * 60);

  if (h < 0)
    h += 360;

  l = (cmax + cmin) / 2;
  s = delta == 0 ? 0 : delta / (1 - Math.abs(2 * l - 1));
  s = +(s * 100).toFixed(1);
  l = +(l * 100).toFixed(1);

  return {h, s, l};
}
  
function increaseLuminosity(hsl, percent) {
  return `hsl(${hsl.h}, ${hsl.s}%, ${Math.min(hsl.l + percent, 100)}%)`;
}

function getCircleNumber(e) {
  return [4, 3, 2, 1, 1, 2, 3, 4][e];
}

function getSelectedTermIndex() {
  let termButtons = document.querySelectorAll(".term-button");
  if (termButtons[0].classList.contains("selected")) return 0;
  if (termButtons[1].classList.contains("selected")) return 1;
  return -1;
}

// Auto-advance functionality

function toggleAutoAdvance() {
  autoAdvanceEnabled = !autoAdvanceEnabled;
  let button = document.getElementById('auto-advance-button');
  if (autoAdvanceEnabled) {
    button.classList.add('active');
  } else {
    button.classList.remove('active');
  }
}

// Edit terms functionality

function openEditTermsModal() {
  document.getElementById('edit-terms-modal').style.display = 'block';
  document.getElementById('terms-list').value = terms.join('\n');
}

function closeEditTermsModal() {
  document.getElementById('edit-terms-modal').style.display = 'none';
}

function saveTerms() {
  let newTerms = document.getElementById('terms-list').value.split('\n').filter(term => term.trim() !== '');
  if (newTerms.length < 2) {
    alert('You need at least two terms for comparison.');
    return;
  }
  terms = newTerms;
  closeEditTermsModal();
  createSurvey();
}

// Event Listeners
document.getElementById('edit-terms-button').addEventListener('click', openEditTermsModal);
document.getElementById('cancel-edit').addEventListener('click', closeEditTermsModal);
document.getElementById('save-terms').addEventListener('click', saveTerms);
document.getElementById('auto-advance-button').addEventListener('click', toggleAutoAdvance);

// Initialization
createSurvey();

</script>
</body>
</html>
